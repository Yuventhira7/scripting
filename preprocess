#!/bin/bash

if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <filename>"
  exit 1
fi

file="$1"

# Step 1: Remove Windows line endings and convert ; to tab, comma to dot
cleaned=$(mktemp)

cat "$file" \
  | tr -d '\r' \
  | sed 's/,/./g' \
  | sed 's/;/\t/g' \
  | tr -cd '\11\12\15\40-\176' \
  > "$cleaned"

# Step 2: Fix missing IDs (awk handles this)
max_id=$(awk -F"\t" 'NR>1 && $1 ~ /^[0-9]+$/ && $1 > max { max=$1 } END { print max }' "$cleaned")

awk -v max_id="$max_id" 'BEGIN { FS=OFS="\t"; id = max_id + 1 }
NR==1 { print; next }
{
  if ($1 == "") $1 = id++
  print
}' "$cleaned"

# Clean up
rm "$cleaned"
