#!/bin/bash

# Check for exactly one argument (cleaned .tsv file)
if [ "$#" -ne 1 ]; then
  echo "Usage: $0 <cleaned_file.tsv>"
  exit 1
fi

file="$1"

# -----------------------------
# Function: Most Popular Mechanic
# -----------------------------
most_popular_mechanic() {
  cut -f13 "$file" | tail -n +2 | \
  tr ',.' '\n' | sed 's/^ *//' | sed '/^$/d' | \
  sort | uniq -c | sort -nr | head -n1 | \
  awk '{print "The most popular game mechanics is " substr($0, index($0,$2)) " found in " $1 " games"}'
}

# -----------------------------
# Function: Most Popular Domain
# -----------------------------
most_popular_domain() {
  cut -f14 "$file" | tail -n +2 | \
  tr ',.' '\n' | sed 's/^ *//' | sed '/^$/d' | \
  sort | uniq -c | sort -nr | head -n1 | \
  awk '{print "The most game domain is " substr($0, index($0,$2)) " found in " $1 " games"}'
}

# -----------------------------
# Function: Correlation (Year Published vs Rating)
# -----------------------------
correlation_year_rating() {
  awk -F"\t" '
    NR > 1 && $3 != "" && $9 != "" {
      x = $3; y = $9;
      sx += x; sy += y;
      sxy += x * y;
      sx2 += x * x;
      sy2 += y * y;
      n++
    }
    END {
      numerator = n * sxy - sx * sy;
      denominator = sqrt((n * sx2 - sx^2) * (n * sy2 - sy^2));
      r = numerator / denominator;
      printf "The correlation between the year of publication and the average rating is %.3f\n", r;
    }
  ' "$file"
}

# -----------------------------
# Function: Correlation (Complexity vs Rating)
# -----------------------------
correlation_complexity_rating() {
  awk -F"\t" '
    NR > 1 && $11 != "" && $9 != "" {
      x = $11; y = $9;
      sx += x; sy += y;
      sxy += x * y;
      sx2 += x * x;
      sy2 += y * y;
      n++
    }
    END {
      numerator = n * sxy - sx * sy;
      denominator = sqrt((n * sx2 - sx^2) * (n * sy2 - sy^2));
      r = numerator / denominator;
      printf "The correlation between the complexity of a game and its average rating is %.3f\n", r;
    }
  ' "$file"
}

# --- Run all steps ---
most_popular_mechanic
most_popular_domain
correlation_year_rating
correlation_complexity_rating
